# ç›®å½•ç»“æ„è¯¦è§£

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [backend/Dockerfile](file://backend/Dockerfile)
- [backend/app.py](file://backend/app.py)
- [backend/llm_client.py](file://backend/llm_client.py)
- [backend/requirements.txt](file://backend/requirements.txt)
- [frontend/Dockerfile](file://frontend/Dockerfile)
- [frontend/vite.config.js](file://frontend/vite.config.js)
- [frontend/src/hooks/useWebSocket.js](file://frontend/src/hooks/useWebSocket.js)
- [frontend/src/hooks/useConversations.js](file://frontend/src/hooks/useConversations.js)
- [frontend/src/components/ChatBox.jsx](file://frontend/src/components/ChatBox.jsx)
- [frontend/src/utils/localStorageManager.js](file://frontend/src/utils/localStorageManager.js)
- [nginx/nginx.conf](file://nginx/nginx.conf)
- [docker-compose.yml](file://docker-compose.yml)
- [README.md](file://README.md)
- [API_SECURITY_GUIDE.md](file://API_SECURITY_GUIDE.md)
</cite>

## ç›®å½•ç»“æ„

æœ¬é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†å‰ç«¯ã€åç«¯å’Œåå‘ä»£ç†æœåŠ¡åˆ†ç¦»ï¼Œé€šè¿‡ Docker Compose è¿›è¡Œç»Ÿä¸€ç¼–æ’ã€‚æ•´ä½“ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜ã€‚

```mermaid
graph TB
subgraph "å®¹å™¨åŒ–æœåŠ¡"
Nginx[nginx: åå‘ä»£ç†]
Backend[backend: åç«¯æœåŠ¡]
Frontend[frontend: å‰ç«¯æœåŠ¡]
end
Nginx --> |ä»£ç† /chat| Backend
Nginx --> |æœåŠ¡é™æ€èµ„æº| Frontend
Backend --> |è°ƒç”¨| LLM[(é˜¿é‡Œäº‘Qwen API)]
Frontend --> |WebSocketè¿æ¥| Backend
style Nginx fill:#f9f,stroke:#333
style Backend fill:#bbf,stroke:#333
style Frontend fill:#f96,stroke:#333
```

**å›¾ç¤ºæ¥æº**  
- [docker-compose.yml](file://docker-compose.yml)
- [nginx/nginx.conf](file://nginx/nginx.conf)
- [backend/app.py](file://backend/app.py)
- [frontend/src/hooks/useWebSocket.js](file://frontend/src/hooks/useWebSocket.js)

### åç«¯æœåŠ¡ (backend/)
åç«¯åŸºäº Python FastAPI æ¡†æ¶ï¼Œæä¾› WebSocket æ¥å£ä¸å‰ç«¯é€šä¿¡ï¼Œå¹¶é€šè¿‡ `llm_client.py` è°ƒç”¨é˜¿é‡Œäº‘ Qwen å¤§æ¨¡å‹ APIã€‚

- **Dockerfile**: å®šä¹‰äº†åŸºäº `python:3.11-slim` çš„è½»é‡çº§è¿è¡Œç¯å¢ƒï¼Œå®‰è£…ä¾èµ–å¹¶å¯åŠ¨ Uvicorn æœåŠ¡å™¨ã€‚
- **app.py**: FastAPI åº”ç”¨å…¥å£ï¼Œå®šä¹‰ `/chat` WebSocket ç«¯ç‚¹ï¼Œå¤„ç†æ¶ˆæ¯æ”¶å‘ä¸å†å²è®°å½•ç®¡ç†ã€‚
- **llm_client.py**: å°è£…å¯¹é˜¿é‡Œäº‘ DashScope API çš„æµå¼è°ƒç”¨é€»è¾‘ï¼Œæ”¯æŒ SSEï¼ˆServer-Sent Eventsï¼‰ã€‚
- **requirements.txt**: åˆ—å‡º Python ä¾èµ–é¡¹ï¼ŒåŒ…æ‹¬ `fastapi`, `uvicorn`, `httpx`, `python-dotenv` ç­‰ã€‚

**åç«¯ç»„ä»¶åä½œæµç¨‹ï¼š**
1. `app.py` åˆå§‹åŒ– `LLMClient()` å®ä¾‹ã€‚
2. å½“ WebSocket è¿æ¥å»ºç«‹åï¼Œæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯å¹¶è¿½åŠ åˆ° `history`ã€‚
3. è°ƒç”¨ `llm.stream(history)` è·å–æµå¼å“åº”ã€‚
4. å°†å¢é‡å†…å®¹é€šè¿‡ WebSocket å®æ—¶å‘é€ç»™å‰ç«¯ã€‚

**åç«¯æ–‡ä»¶ä¾èµ–å…³ç³»ï¼š**
```mermaid
flowchart TD
A["app.py<br/>WebSocket å…¥å£"] --> B["llm_client.py<br/>LLM å®¢æˆ·ç«¯"]
B --> C["é˜¿é‡Œäº‘ Qwen API"]
A --> D["requirements.txt<br/>ä¾èµ–ç®¡ç†"]
A --> E[".env<br/>ç¯å¢ƒå˜é‡"]
```

**å›¾ç¤ºæ¥æº**  
- [backend/app.py](file://backend/app.py#L1-L107)
- [backend/llm_client.py](file://backend/llm_client.py#L1-L87)

### å‰ç«¯æœåŠ¡ (frontend/)
å‰ç«¯é‡‡ç”¨ React + Vite æ„å»ºï¼Œä½¿ç”¨ Tailwind CSS è¿›è¡Œæ ·å¼è®¾è®¡ï¼Œæä¾›ç°ä»£åŒ–çš„èŠå¤©ç•Œé¢ã€‚

- **public/**: å­˜æ”¾é™æ€èµ„æºï¼Œå¦‚ `index.html` å’Œæµ‹è¯•é¡µé¢ `test-websocket.html`ã€‚
- **src/components/**: UI ç»„ä»¶ç›®å½•ï¼ŒåŒ…å«èŠå¤©æ°”æ³¡ã€è¾“å…¥æ ã€ä¾§è¾¹æ ç­‰ã€‚
- **src/hooks/**: è‡ªå®šä¹‰ Hookï¼Œç®¡ç† WebSocket è¿æ¥ã€ä¼šè¯çŠ¶æ€ã€ä¸»é¢˜åˆ‡æ¢ç­‰ã€‚
- **src/utils/**: å·¥å…·å‡½æ•°ï¼Œå¦‚ `localStorageManager.js` ç”¨äºæŒä¹…åŒ–èŠå¤©è®°å½•ã€‚
- **vite.config.js**: é…ç½®å¼€å‘æœåŠ¡å™¨ä»£ç†ï¼Œå°† `/api` è¯·æ±‚è½¬å‘è‡³åç«¯ã€‚
- **Dockerfile**: ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œå…ˆå®‰è£…ä¾èµ–å¹¶æ„å»ºç”Ÿäº§åŒ…ï¼Œå†ä½¿ç”¨ Nginx éƒ¨ç½²ã€‚
- **package.json**: å®šä¹‰é¡¹ç›®ä¾èµ–å’Œè„šæœ¬å‘½ä»¤ã€‚

**å…³é”® Hook åˆ†æï¼š**

#### useWebSocket.js
ç®¡ç† WebSocket ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è¿æ¥ã€é‡è¿ã€æ¶ˆæ¯æ¥æ”¶ä¸é”™è¯¯å¤„ç†ã€‚

```javascript
const ws = new WebSocket('ws://localhost:8000/chat');
```

è¯¥ Hook ä½¿ç”¨ `useRef` è·Ÿè¸ªè¿æ¥çŠ¶æ€ï¼Œå¹¶é€šè¿‡ `window.handleWebSocketMessage` å›è°ƒæœºåˆ¶ä¸ç»„ä»¶é€šä¿¡ã€‚

**å›¾ç¤ºæ¥æº**  
- [frontend/src/hooks/useWebSocket.js](file://frontend/src/hooks/useWebSocket.js#L1-L193)

#### useConversations.js
ç®¡ç†å¤šä¸ªèŠå¤©ä¼šè¯çš„çŠ¶æ€ï¼Œæ”¯æŒæ–°å»ºã€åˆ‡æ¢å’Œæœ¬åœ°æŒä¹…åŒ–ã€‚

```javascript
useEffect(() => {
  localStorage.setItem('chatConversations', JSON.stringify(conversations));
}, [conversations]);
```

åˆå§‹ä¼šè¯åŒ…å«æ¬¢è¿æ¶ˆæ¯ï¼Œæ ‡é¢˜æ ¹æ®ç”¨æˆ·é¦–æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆã€‚

**å›¾ç¤ºæ¥æº**  
- [frontend/src/hooks/useConversations.js](file://frontend/src/hooks/useConversations.js#L1-L119)

#### ChatBox.jsx
èŠå¤©å†…å®¹å±•ç¤ºç»„ä»¶ï¼Œä½¿ç”¨ `MessageBubble` æ¸²æŸ“æ¯æ¡æ¶ˆæ¯ï¼Œå¹¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ã€‚

```jsx
<div ref={messagesEndRef} />
```

é€šè¿‡ `messagesEndRef` å®ç°å¹³æ»‘æ»šåŠ¨å®šä½ã€‚

**å›¾ç¤ºæ¥æº**  
- [frontend/src/components/ChatBox.jsx](file://frontend/src/components/ChatBox.jsx#L1-L30)

### Nginx æœåŠ¡ (nginx/)
Nginx ä½œä¸ºåå‘ä»£ç†ï¼Œç»Ÿä¸€æš´éœ²æœåŠ¡å…¥å£ï¼Œå®ç°å‰åç«¯èšåˆè®¿é—®ã€‚

- **nginx.conf**: é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰ç›‘å¬ç«¯å£ã€é™æ€èµ„æºè·¯å¾„å’Œ WebSocket ä»£ç†è§„åˆ™ã€‚

```nginx
location /chat {
    proxy_pass http://backend:8000/chat;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

æ­¤é…ç½®ç¡®ä¿ WebSocket åè®®å‡çº§è¯·æ±‚è¢«æ­£ç¡®è½¬å‘ã€‚

**å›¾ç¤ºæ¥æº**  
- [nginx/nginx.conf](file://nginx/nginx.conf#L1-L27)

### é¡¹ç›®æ ¹ç›®å½•æ–‡ä»¶
- **docker-compose.yml**: å®šä¹‰ä¸‰ä¸ªæœåŠ¡ï¼ˆbackendã€frontendã€nginxï¼‰ï¼Œé…ç½®ç«¯å£æ˜ å°„ã€ä¾èµ–å…³ç³»å’Œå·æŒ‚è½½ã€‚
- **README.md**: é¡¹ç›®è¯´æ˜æ–‡æ¡£ï¼ŒåŒ…å«å¯åŠ¨æ­¥éª¤ã€API å¯†é’¥é…ç½®å’Œæœ¬åœ°å¼€å‘æŒ‡å—ã€‚
- **API_SECURITY_GUIDE.md**: å¼ºè°ƒ API å¯†é’¥å®‰å…¨ï¼Œç¦æ­¢ç¡¬ç¼–ç ï¼Œæ¨èä½¿ç”¨ç¯å¢ƒå˜é‡æˆ– `.env` æ–‡ä»¶ã€‚
- **ui_design.md**: ç”¨æˆ·ç•Œé¢è®¾è®¡æ–‡æ¡£ï¼ˆå†…å®¹æœªæä¾›ï¼‰ã€‚

## ç³»ç»Ÿæ¶æ„ä¸é€šä¿¡æœºåˆ¶

### æœåŠ¡ç¼–æ’ä¸ç½‘ç»œé€šä¿¡
é€šè¿‡ `docker-compose.yml` å®šä¹‰çš„æœåŠ¡ä¾èµ–ï¼Œç¡®ä¿å¯åŠ¨é¡ºåºåˆç†ï¼š

```yaml
services:
  backend:
    build: ./backend
    ports: "8000:8000"
    environment: API_KEY=${API_KEY}

  frontend:
    build: ./frontend
    ports: "3000:3000"
    depends_on: backend

  nginx:
    image: nginx:alpine
    ports: "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/build:/usr/share/nginx/html
    depends_on: [backend, frontend]
```

- **ç«¯å£æ˜ å°„**ï¼š
  - Nginx ç›‘å¬å®¿ä¸»æœº 80 ç«¯å£ï¼Œæä¾›ç»Ÿä¸€å…¥å£ã€‚
  - å‰ç«¯å¼€å‘æœåŠ¡å™¨è¿è¡Œåœ¨ 3000 ç«¯å£ï¼ˆå®¹å™¨å†…ï¼‰ã€‚
  - åç«¯ API æœåŠ¡è¿è¡Œåœ¨ 8000 ç«¯å£ï¼ˆå®¹å™¨å†…ï¼‰ã€‚

- **å·æŒ‚è½½**ï¼š
  - Nginx é…ç½®æ–‡ä»¶æŒ‚è½½è‡³å®¹å™¨å†…ã€‚
  - å‰ç«¯æ„å»ºäº§ç‰©æŒ‚è½½ä¸ºé™æ€èµ„æºç›®å½•ã€‚

### è¯·æ±‚æµç¨‹åˆ†æ
1. ç”¨æˆ·è®¿é—® `http://localhost`ï¼ˆNginx 80 ç«¯å£ï¼‰ã€‚
2. Nginx è¿”å›å‰ç«¯ `index.html` å’Œé™æ€èµ„æºã€‚
3. å‰ç«¯ JavaScript åˆå§‹åŒ– WebSocket è¿æ¥ `ws://localhost:8000/chat`ã€‚
4. Nginx å°† WebSocket è¯·æ±‚ä»£ç†è‡³ `backend:8000`ã€‚
5. åç«¯ `app.py` æ¥æ”¶æ¶ˆæ¯ï¼Œè°ƒç”¨ `llm_client.py` æµå¼è·å–å“åº”ã€‚
6. å“åº”é€šè¿‡ WebSocket åˆ†å—è¿”å›å‰ç«¯ï¼Œå®æ—¶æ¸²æŸ“ã€‚

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Nginx as Nginx
participant Frontend as å‰ç«¯
participant Backend as åç«¯
participant LLM as é˜¿é‡Œäº‘Qwen
User->>Nginx : è®¿é—® http : //localhost
Nginx->>Frontend : è¿”å› index.html
Frontend->>Frontend : åˆå§‹åŒ– React åº”ç”¨
Frontend->>Nginx : WebSocket è¿æ¥ ws : //localhost/chat
Nginx->>Backend : ä»£ç† WebSocket è¯·æ±‚
Backend->>Backend : æ¥å—è¿æ¥ï¼Œåˆå§‹åŒ–å†å²è®°å½•
User->>Frontend : è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
Frontend->>Backend : WebSocket å‘é€æ–‡æœ¬
Backend->>LLM : POST /generation (æµå¼)
LLM-->>Backend : SSE æ•°æ®æµ
Backend-->>Frontend : WebSocket åˆ†å—å‘é€å“åº”
Frontend->>User : å®æ—¶æ˜¾ç¤ºå›å¤
```

**å›¾ç¤ºæ¥æº**  
- [docker-compose.yml](file://docker-compose.yml)
- [nginx/nginx.conf](file://nginx/nginx.conf)
- [backend/app.py](file://backend/app.py)
- [backend/llm_client.py](file://backend/llm_client.py)
- [frontend/src/hooks/useWebSocket.js](file://frontend/src/hooks/useWebSocket.js)

## æ¶æ„è®¾è®¡è€ƒé‡

### ä¸ºä½•é‡‡ç”¨ç‹¬ç«‹ Dockerfile è€Œéå•ä½“é•œåƒï¼Ÿ
1. **èŒè´£åˆ†ç¦»**ï¼šå‰ç«¯ï¼ˆé™æ€èµ„æºï¼‰ä¸åç«¯ï¼ˆåŠ¨æ€æœåŠ¡ï¼‰æŠ€æœ¯æ ˆä¸åŒï¼Œç‹¬ç«‹æ„å»ºæ›´æ¸…æ™°ã€‚
2. **éƒ¨ç½²çµæ´»æ€§**ï¼šå¯å•ç‹¬æ›´æ–°å‰ç«¯æˆ–åç«¯ï¼Œæ— éœ€é‡å»ºæ•´ä¸ªåº”ç”¨ã€‚
3. **èµ„æºä¼˜åŒ–**ï¼šå‰ç«¯ä½¿ç”¨ Nginx é•œåƒï¼Œåç«¯ä½¿ç”¨ Python é•œåƒï¼Œé¿å…å†—ä½™ä¾èµ–ã€‚
4. **å¼€å‘æ•ˆç‡**ï¼šå‰ç«¯ Vite æ”¯æŒçƒ­é‡è½½ï¼Œåç«¯ FastAPI æ”¯æŒè‡ªåŠ¨é‡å¯ï¼Œç‹¬ç«‹å®¹å™¨ä¾¿äºè°ƒè¯•ã€‚

### å®‰å…¨å®è·µ
- **API å¯†é’¥ä¿æŠ¤**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼Œé¿å…ç¡¬ç¼–ç ã€‚
- **CORS é…ç½®**ï¼š`app.py` ä¸­å…è®¸æ‰€æœ‰æ¥æºï¼Œé€‚ç”¨äºå¼€å‘ç¯å¢ƒï¼›ç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶åŸŸåã€‚
- **æ—¥å¿—è„±æ•**ï¼š`llm_client.py` è®°å½•è¯·æ±‚æ—¶ä¸è¾“å‡ºå®Œæ•´ payloadï¼Œä¿æŠ¤éšç§ã€‚

### çŠ¶æ€ç®¡ç†ç­–ç•¥
- **å‰ç«¯çŠ¶æ€**ï¼šä½¿ç”¨ React Hooks (`useState`, `useRef`) ç®¡ç† UI çŠ¶æ€ã€‚
- **ä¼šè¯æŒä¹…åŒ–**ï¼šé€šè¿‡ `localStorage` å­˜å‚¨ `chatConversations`ï¼Œåˆ·æ–°é¡µé¢ä¸ä¸¢å¤±å†å²ã€‚
- **WebSocket çŠ¶æ€**ï¼š`useWebSocket` Hook å°è£…è¿æ¥çŠ¶æ€ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿å’Œé¡µé¢å¯è§æ€§æ£€æµ‹ã€‚

## åˆå­¦è€…æŒ‡å—

### å¦‚ä½•å¯åŠ¨é¡¹ç›®ï¼Ÿ
1. è®¾ç½® API å¯†é’¥ï¼š
   ```bash
   export API_KEY=your_actual_api_key_here
   ```
2. æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼š
   ```bash
   docker-compose up --build
   ```
3. è®¿é—® `http://localhost`ã€‚

### å¦‚ä½•ä¿®æ”¹å‰ç«¯ API åœ°å€ï¼Ÿ
åœ¨ `useWebSocket.js` ä¸­ä¿®æ”¹ WebSocket URLï¼š
```js
const ws = new WebSocket('ws://your-backend-host:8000/chat');
```

### å¦‚ä½•æµ‹è¯• WebSocketï¼Ÿ
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œæ‰§è¡Œï¼š
```javascript
const ws = new WebSocket('ws://localhost:8000/chat');
ws.onopen = () => { console.log('âœ… å·²è¿æ¥'); ws.send('ä½ å¥½'); };
ws.onmessage = (e) => console.log('ğŸ“¨ æ”¶åˆ°:', e.data);
```

## é«˜çº§ç”¨æˆ·è¯´æ˜

### è‡ªå®šä¹‰æ¨¡å‹å‚æ•°
å¯åœ¨ `llm_client.py` çš„ `stream` æ–¹æ³•ä¸­ä¿®æ”¹ `parameters`ï¼š
```python
"parameters": {
    "result_format": "message",
    "temperature": 0.7,
    "top_p": 0.9
}
```

### æ‰©å±•åŠŸèƒ½å»ºè®®
- **ä¼šè¯å­˜å‚¨**ï¼šå°† `localStorage` æ›¿æ¢ä¸ºåç«¯æ•°æ®åº“ï¼ˆå¦‚ Redisï¼‰ã€‚
- **ç”¨æˆ·è®¤è¯**ï¼šæ·»åŠ  JWT éªŒè¯ï¼Œä¿æŠ¤ WebSocket ç«¯ç‚¹ã€‚
- **æ¶ˆæ¯åŠ å¯†**ï¼šåœ¨ä¼ è¾“å±‚æˆ–åº”ç”¨å±‚å®ç°ç«¯åˆ°ç«¯åŠ å¯†ã€‚
- **è´Ÿè½½å‡è¡¡**ï¼šNginx å‰ç½®å¤šå®ä¾‹åç«¯ï¼Œæå‡å¹¶å‘èƒ½åŠ›ã€‚

## æ€»ç»“

æœ¬é¡¹ç›®å±•ç¤ºäº†ç°ä»£ Web åº”ç”¨çš„å…¸å‹æ¶æ„ï¼šå‰ç«¯ React + åç«¯ FastAPI + Nginx åå‘ä»£ç† + Docker å®¹å™¨åŒ–ã€‚é€šè¿‡æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†å’Œåˆç†çš„é€šä¿¡æœºåˆ¶ï¼Œå®ç°äº†é«˜æ•ˆã€å¯ç»´æŠ¤çš„èŠå¤©ç³»ç»Ÿã€‚å…¶è®¾è®¡å…¼é¡¾äº†å¼€å‘ä¾¿æ·æ€§ä¸éƒ¨ç½²çµæ´»æ€§ï¼Œæ˜¯å­¦ä¹ å…¨æ ˆå¼€å‘çš„è‰¯å¥½èŒƒä¾‹ã€‚